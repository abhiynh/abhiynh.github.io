<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Post - Y N Hosakote</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Lexend',sans-serif;background:#eef2f7;}
</style>
</head>

<body class="min-h-screen">

<!-- HEADER -->
<header class="bg-white shadow p-4 flex justify-between items-center">
<h1 class="font-bold text-lg">Create Post</h1>
<a href="feed.html" class="text-blue-600 font-semibold">Back</a>
</header>

<!-- FORM -->
<div class="max-w-xl mx-auto mt-8 bg-white rounded-2xl shadow-lg p-6">

<textarea id="postText"
class="w-full border rounded-xl p-4 h-32 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
placeholder="What's happening in Y N Hosakote?"></textarea>

<input type="file" id="imageInput" accept="image/*"
class="mt-4 w-full">

<img id="preview" class="hidden mt-4 rounded-xl"/>

<button id="postBtn"
class="mt-6 w-full bg-blue-600 text-white py-3 rounded-xl font-bold">
Post Now
</button>

<p id="status" class="text-center text-sm mt-4 text-gray-500"></p>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";

import {
  getFirestore,
  addDoc,
  collection,
  serverTimestamp,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCpNAu49OymCjNuRl7aRBRYQm0P6M0db0s",
  authDomain: "ynhosakote-community.firebaseapp.com",
  projectId: "ynhosakote-community",
  storageBucket: "ynhosakote-community.firebasestorage.app",
  messagingSenderId: "1053474727552",
  appId: "1:1053474727552:web:9ed2d6523ef935fd666865"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let authorName = "";

/* Require Login + Get User Name */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location="citizen_login.html";
    return;
  }

  currentUser = user;

  const userDoc = await getDoc(doc(db,"users",user.uid));
  authorName = userDoc.data().name;
});

/* Preview Image */
const imageInput = document.getElementById("imageInput");
const preview = document.getElementById("preview");

imageInput.onchange = ()=>{
  const file = imageInput.files[0];
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");
};

/* POST BUTTON */
document.getElementById("postBtn").onclick = async ()=>{

  const text = document.getElementById("postText").value;
  const file = imageInput.files[0];
  const status = document.getElementById("status");

  if(!text && !file){
    status.innerText="Write something or select image";
    return;
  }

  status.innerText="Uploading image...";

  let imageUrl = "";

  /* Upload to Cloudinary */
  if(file){
    const formData = new FormData();
    formData.append("file",file);
    formData.append("upload_preset","ynhosakote_posts");

    const res = await fetch("https://api.cloudinary.com/v1_1/dnbfx0ynh/image/upload",{
      method:"POST",
      body:formData
    });

    const data = await res.json();
    imageUrl = data.secure_url;
  }

  status.innerText="Publishing post...";

  /* Save Post in Firestore */
  await addDoc(collection(db,"posts"),{
    text:text,
    imageUrl:imageUrl,
    authorName:authorName,
    uid:currentUser.uid,
    createdAt:serverTimestamp()
  });

  status.innerText="Posted successfully!";
  window.location="feed.html";
};

</script>

</body>
</html>