<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Community Feed</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Lexend',sans-serif;background:#eef2f7;}
</style>
</head>

<body>

<!-- LOGIN CHECK LOADER -->
<div id="authLoader" class="fixed inset-0 bg-white flex items-center justify-center z-50">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-gray-900 mx-auto"></div>
    <p class="mt-4 text-gray-600">Checking login...</p>
  </div>
</div>

<header class="bg-white shadow p-4 flex justify-between items-center">
<h1 class="font-bold text-lg">Y N Hosakote Community</h1>
<a href="create-post.html" class="bg-blue-600 text-white px-4 py-2 rounded-lg">+ Post</a>
</header>

<div id="feed" class="max-w-xl mx-auto mt-6 space-y-6"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  orderBy,
  onSnapshot,
  doc,
  updateDoc,
  addDoc,
  serverTimestamp,
  where,
  getDocs,
  deleteDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCpNAu49OymCjNuRl7aRBRYQm0P6M0db0s",
  authDomain: "ynhosakote-community.firebaseapp.com",
  projectId: "ynhosakote-community",
  storageBucket: "ynhosakote-community.firebasestorage.app",
  messagingSenderId: "1053474727552",
  appId: "1:1053474727552:web:9ed2d6523ef935fd666865"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser;

/* ===== SECURE AUTH GUARD ===== */
onAuthStateChanged(auth, async (user) => {

  // still checking login
  if(user === null){
    window.location = "citizen_login.html";
    return;
  }

  currentUser = user;

  /* CHECK IF USER APPROVED BY ADMIN */
  const userDoc = await getDoc(doc(db,"users",user.uid));

  if(!userDoc.exists()){
    alert("Account not approved by admin");
    await signOut(auth);
    window.location = "citizen_login.html";
    return;
  }

  // hide loader ONLY AFTER verification
  document.getElementById("authLoader").style.display="none";

  loadPosts(); // now safe to load feed
});

/* ===== LOAD POSTS ===== */

const feed = document.getElementById("feed");

function loadPosts(){

const q = query(collection(db,"posts"),orderBy("createdAt","desc"));

onSnapshot(q,(snapshot)=>{
  feed.innerHTML="";

  snapshot.forEach(docSnap=>{
    const p = docSnap.data();
    const id = docSnap.id;

    feed.innerHTML+=`
    <div class="bg-white p-4 rounded-2xl shadow">
      <h3 class="font-bold">${p.authorName || "Member"}</h3>
      <p class="mt-2">${p.text||""}</p>
      ${p.imageUrl?`<img src="${p.imageUrl}" class="mt-3 rounded-xl">`:""}

      <div class="flex justify-around mt-4 text-gray-600">
        <button onclick="likePost('${id}',${p.likeCount||0})">‚ù§Ô∏è ${p.likeCount||0}</button>
        <button onclick="commentPost('${id}')">üí¨ Comment</button>
        <button onclick="reportPost('${id}')">üö© Report</button>
      </div>
    </div>
    `;
  });
});
}

/* ===== LIKE ===== */
window.likePost = async(postId,count)=>{

const likeQuery = query(collection(db,"likes"),
where("postId","==",postId),
where("uid","==",currentUser.uid));

const likeSnap = await getDocs(likeQuery);

if(likeSnap.empty){

await addDoc(collection(db,"likes"),{
postId:postId,
uid:currentUser.uid
});

await updateDoc(doc(db,"posts",postId),{
likeCount:count+1
});

}else{

likeSnap.forEach(async(d)=>{
await deleteDoc(doc(db,"likes",d.id));
});

await updateDoc(doc(db,"posts",postId),{
likeCount:count-1
});
}
};

/* ===== COMMENT ===== */
window.commentPost = async(postId)=>{
const text = prompt("Enter comment");
if(!text) return;

await addDoc(collection(db,"comments"),{
postId:postId,
uid:currentUser.uid,
authorName:currentUser.email,
text:text,
createdAt:serverTimestamp()
});
};

/* ===== REPORT ===== */
window.reportPost = async(postId)=>{
const reason = prompt("Report reason?");
if(!reason) return;

await addDoc(collection(db,"reports"),{
postId:postId,
reporterUid:currentUser.uid,
reason:reason,
createdAt:serverTimestamp()
});

alert("Reported to admin");
};

</script>

</body>
</html>