<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Y N Hosakote</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Lexend',sans-serif;background:#eef2f7;}
</style>
</head>

<body>

<header class="bg-blue-700 text-white p-4 flex justify-between">
<h1 class="font-bold">Admin Control Panel</h1>
<button id="logout" class="bg-white text-blue-700 px-3 py-1 rounded">Logout</button>
</header>

<div class="max-w-5xl mx-auto mt-6">

<h2 class="text-2xl font-bold mb-4">ðŸš© Reported Posts</h2>
<div id="reports" class="space-y-4"></div>

<hr class="my-10">

<h2 class="text-2xl font-bold mb-4">ðŸ‘¥ Members</h2>
<div id="users" class="space-y-4"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  query,
  onSnapshot,
  doc,
  getDoc,
  deleteDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCpNAu49OymCjNuRl7aRBRYQm0P6M0db0s",
  authDomain: "ynhosakote-community.firebaseapp.com",
  projectId: "ynhosakote-community",
  storageBucket: "ynhosakote-community.firebasestorage.app",
  messagingSenderId: "1053474727552",
  appId: "1:1053474727552:web:9ed2d6523ef935fd666865"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const reportsDiv = document.getElementById("reports");
const usersDiv = document.getElementById("users");

/* ADMIN CHECK */
onAuthStateChanged(auth, async(user)=>{
  if(!user){
    window.location="citizen_login.html";
    return;
  }

  const userDoc = await getDoc(doc(db,"users",user.uid));

  if(!userDoc.exists() || userDoc.data().role !== "admin"){
    alert("Access denied");
    window.location="feed.html";
    return;
  }

  loadReports();
  loadUsers();
});

/* LOAD REPORTS */
function loadReports(){
  const q = query(collection(db,"reports"));

  onSnapshot(q, async(snapshot)=>{
    reportsDiv.innerHTML="";

    for(const r of snapshot.docs){

      const report = r.data();
      const postDoc = await getDoc(doc(db,"posts",report.postId));

      if(!postDoc.exists()) continue;

      const post = postDoc.data();

      reportsDiv.innerHTML += `
      <div class="bg-white p-4 rounded-xl shadow">
        <p class="font-bold text-red-600">Report Reason:</p>
        <p class="mb-2">${report.reason}</p>

        <p class="font-semibold">${post.authorName}</p>
        <p>${post.text||""}</p>
        ${post.imageUrl?`<img src="${post.imageUrl}" class="mt-2 rounded">`:""}

        <div class="flex gap-3 mt-4">
          <button onclick="deletePost('${report.postId}','${r.id}')" 
          class="bg-red-600 text-white px-4 py-2 rounded">
          Delete Post
          </button>

          <button onclick="dismissReport('${r.id}')" 
          class="bg-gray-400 text-white px-4 py-2 rounded">
          Ignore
          </button>
        </div>
      </div>
      `;
    }
  });
}

/* DELETE POST */
window.deletePost = async(postId,reportId)=>{
  await deleteDoc(doc(db,"posts",postId));
  await deleteDoc(doc(db,"reports",reportId));
  alert("Post removed");
};

/* DISMISS REPORT */
window.dismissReport = async(reportId)=>{
  await deleteDoc(doc(db,"reports",reportId));
};

/* LOAD USERS */
function loadUsers(){
  const q = query(collection(db,"users"));

  onSnapshot(q,(snapshot)=>{
    usersDiv.innerHTML="";

    snapshot.forEach(docSnap=>{
      const u = docSnap.data();
      const id = docSnap.id;

      usersDiv.innerHTML+=`
      <div class="bg-white p-4 rounded-xl shadow flex justify-between items-center">
        <div>
          <p class="font-bold">${u.name||"User"}</p>
          <p class="text-sm text-gray-500">${id}</p>
          <p class="text-sm">Role: ${u.role}</p>
        </div>

        <button onclick="banUser('${id}')" 
        class="bg-red-500 text-white px-4 py-2 rounded">
        Ban
        </button>
      </div>
      `;
    });
  });
}

/* BAN USER */
window.banUser = async(uid)=>{
  await updateDoc(doc(db,"users",uid),{
    approved:false
  });
  alert("User banned");
};

/* LOGOUT */
document.getElementById("logout").onclick=()=>{
  signOut(auth);
  window.location="citizen_login.html";
};

</script>

</body>
</html>